function [ Q_s_dx, Q_theta_dx ] = genForcesDx( params, s, theta, sd, thetad, tau_B1, tau_B2)
% Compute derivative of generalized forces w.r.t. x
% Input:
%   params      fixed parameters
%   s,theta,sd,thetad
%   tau_B1
%   tau_B2
% Output:
%   Q_s_dx        derivative of generalized force Q_s w.r.t x
%   Q_theta_dx    derivative of generalized force Q_theta w.r.t. x


% for convenience and readability, rename base_ang
phi = params.ang_base;

% avoid calling params
l2 = params.l2;
l5 = params.l5;
r_B1 = params.r_B1;
r_B2 = params.r_B2;
r_P1 = params.r_P1;
r_P2 = params.r_P2;
mu_B1 = params.mu_B1;
mu_B2 = params.mu_B2;
mu_P1 = params.mu_P1;
mu_P2 = params.mu_P2;


Q_s_dx = zeros(4,1);

Q_s_dx(1) = (sin(conj(theta))*(sin(theta)*(l5 + s) - l2*sin(phi))*(2*sign(sin(theta)*(l5 + s) - l2*sin(phi))*sin(theta)*abs(sin(theta)*(l5 + s) - l2*sin(phi)) + 2*abs(cos(theta)*(l5 + s) - l2*cos(phi))*cos(theta)*sign(cos(theta)*(l5 + s) - l2*cos(phi)))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(2*(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(3/2)) - (sin(conj(theta))*(sin(theta)*(l5 + s) - l2*sin(phi))*((mu_B1*(sd - l2*thetad*sin(phi - theta)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (mu_P1*(sd - l2*thetad*sin(phi - theta)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s)))*(2*l5 + 2*s - 2*l2*cos(phi - theta)))/(2*r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2)) - (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s)))*(2*l5 + 2*s - 2*l2*cos(phi - theta)))/(2*r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (cos(conj(theta))*cos(theta)*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (sin(conj(theta))*sin(theta)*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (cos(conj(theta))*(cos(theta)*(l5 + s) - l2*cos(phi))*((mu_B1*(sd - l2*thetad*sin(phi - theta)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (mu_P1*(sd - l2*thetad*sin(phi - theta)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s)))*(2*l5 + 2*s - 2*l2*cos(phi - theta)))/(2*r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2)) - (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s)))*(2*l5 + 2*s - 2*l2*cos(phi - theta)))/(2*r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (cos(conj(theta))*(cos(theta)*(l5 + s) - l2*cos(phi))*(2*sign(sin(theta)*(l5 + s) - l2*sin(phi))*sin(theta)*abs(sin(theta)*(l5 + s) - l2*sin(phi)) + 2*abs(cos(theta)*(l5 + s) - l2*cos(phi))*cos(theta)*sign(cos(theta)*(l5 + s) - l2*cos(phi)))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(2*(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(3/2));


Q_s_dx(2) = (sin(conj(theta))*(cos(theta)*(l5 + s) - l2*cos(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (cos(conj(theta))*(sin(theta)*(l5 + s) - l2*sin(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (cos(conj(theta))*(cos(theta)*(l5 + s) - l2*cos(phi))*((l2*mu_B1*(sd*sin(phi - theta) - thetad*cos(phi - theta)*(l5 + s)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (l2*mu_P1*(sd*sin(phi - theta) - thetad*cos(phi - theta)*(l5 + s)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (l2*mu_B1*sin(phi - theta)*(l5 + s)*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2)) - (l2*mu_P1*sin(phi - theta)*(l5 + s)*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (sin(conj(theta))*(sin(theta)*(l5 + s) - l2*sin(phi))*((l2*mu_B1*(sd*sin(phi - theta) - thetad*cos(phi - theta)*(l5 + s)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (l2*mu_P1*(sd*sin(phi - theta) - thetad*cos(phi - theta)*(l5 + s)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (l2*mu_B1*sin(phi - theta)*(l5 + s)*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2)) - (l2*mu_P1*sin(phi - theta)*(l5 + s)*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (cos(conj(theta))*(2*abs(cos(theta)*(l5 + s) - l2*cos(phi))*sin(theta)*sign(cos(theta)*(l5 + s) - l2*cos(phi))*(l5 + s) - 2*sign(sin(theta)*(l5 + s) - l2*sin(phi))*cos(theta)*abs(sin(theta)*(l5 + s) - l2*sin(phi))*(l5 + s))*(cos(theta)*(l5 + s) - l2*cos(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(2*(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(3/2)) - (sin(conj(theta))*(2*abs(cos(theta)*(l5 + s) - l2*cos(phi))*sin(theta)*sign(cos(theta)*(l5 + s) - l2*cos(phi))*(l5 + s) - 2*sign(sin(theta)*(l5 + s) - l2*sin(phi))*cos(theta)*abs(sin(theta)*(l5 + s) - l2*sin(phi))*(l5 + s))*(sin(theta)*(l5 + s) - l2*sin(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(2*(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(3/2)) + (cos(conj(theta))*sin(theta)*(l5 + s)*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (sin(conj(theta))*cos(theta)*(l5 + s)*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2);



Q_s_dx(3) = - cos(conj(theta))*cos(theta)*(mu_B2/r_B2 + mu_P2/r_P2) - sin(conj(theta))*sin(theta)*(mu_B2/r_B2 + mu_P2/r_P2) - (cos(conj(theta))*((mu_B1*(l5 + s - l2*cos(phi - theta)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (mu_P1*(l5 + s - l2*cos(phi - theta)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)))*(cos(theta)*(l5 + s) - l2*cos(phi)))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (sin(conj(theta))*((mu_B1*(l5 + s - l2*cos(phi - theta)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (mu_P1*(l5 + s - l2*cos(phi - theta)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)))*(sin(theta)*(l5 + s) - l2*sin(phi)))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2);



Q_s_dx(4) = (sin(conj(theta))*((l2*mu_B1*sin(phi - theta)*(l5 + s))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (l2*mu_P1*sin(phi - theta)*(l5 + s))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)))*(sin(theta)*(l5 + s) - l2*sin(phi)))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (cos(conj(theta))*(cos(theta)*(l5 + s) - l2*cos(phi))*((l2*mu_B1*sin(phi - theta)*(l5 + s))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (l2*mu_P1*sin(phi - theta)*(l5 + s))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2);







%%

Q_theta_dx = zeros(4,1);

Q_theta_dx(1) = sin(conj(theta))*cos(theta)*((mu_B2*sd)/r_B2 - tau_B2/r_B2 + (mu_P2*sd)/r_P2) - cos(conj(theta))*sin(theta)*((mu_B2*sd)/r_B2 - tau_B2/r_B2 + (mu_P2*sd)/r_P2) + (sin(conj(theta))*(cos(theta)*(l5 + s) - l2*cos(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (cos(conj(theta))*(sin(theta)*(l5 + s) - l2*sin(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (sin(conj(theta))*(conj(l5) + conj(s))*(cos(theta)*(l5 + s) - l2*cos(phi))*((mu_B1*(sd - l2*thetad*sin(phi - theta)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (mu_P1*(sd - l2*thetad*sin(phi - theta)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s)))*(2*l5 + 2*s - 2*l2*cos(phi - theta)))/(2*r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2)) - (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s)))*(2*l5 + 2*s - 2*l2*cos(phi - theta)))/(2*r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (cos(conj(theta))*(conj(l5) + conj(s))*(sin(theta)*(l5 + s) - l2*sin(phi))*((mu_B1*(sd - l2*thetad*sin(phi - theta)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (mu_P1*(sd - l2*thetad*sin(phi - theta)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s)))*(2*l5 + 2*s - 2*l2*cos(phi - theta)))/(2*r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2)) - (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s)))*(2*l5 + 2*s - 2*l2*cos(phi - theta)))/(2*r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (cos(conj(theta))*sin(theta)*(conj(l5) + conj(s))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (sin(conj(theta))*cos(theta)*(conj(l5) + conj(s))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (cos(conj(theta))*(conj(l5) + conj(s))*(sin(theta)*(l5 + s) - l2*sin(phi))*(2*sign(sin(theta)*(l5 + s) - l2*sin(phi))*sin(theta)*abs(sin(theta)*(l5 + s) - l2*sin(phi)) + 2*abs(cos(theta)*(l5 + s) - l2*cos(phi))*cos(theta)*sign(cos(theta)*(l5 + s) - l2*cos(phi)))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(2*(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(3/2)) - (sin(conj(theta))*(conj(l5) + conj(s))*(cos(theta)*(l5 + s) - l2*cos(phi))*(2*sign(sin(theta)*(l5 + s) - l2*sin(phi))*sin(theta)*abs(sin(theta)*(l5 + s) - l2*sin(phi)) + 2*abs(cos(theta)*(l5 + s) - l2*cos(phi))*cos(theta)*sign(cos(theta)*(l5 + s) - l2*cos(phi)))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(2*(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(3/2));



Q_theta_dx(2) = (cos(conj(theta))*(conj(l5) + conj(s))*(cos(theta)*(l5 + s) - l2*cos(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (sin(conj(theta))*(conj(l5) + conj(s))*(sin(theta)*(l5 + s) - l2*sin(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (sin(conj(theta))*(conj(l5) + conj(s))*(cos(theta)*(l5 + s) - l2*cos(phi))*((l2*mu_B1*(sd*sin(phi - theta) - thetad*cos(phi - theta)*(l5 + s)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (l2*mu_P1*(sd*sin(phi - theta) - thetad*cos(phi - theta)*(l5 + s)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (l2*mu_B1*sin(phi - theta)*(l5 + s)*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2)) - (l2*mu_P1*sin(phi - theta)*(l5 + s)*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (cos(conj(theta))*(conj(l5) + conj(s))*(sin(theta)*(l5 + s) - l2*sin(phi))*((l2*mu_B1*(sd*sin(phi - theta) - thetad*cos(phi - theta)*(l5 + s)))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) + (l2*mu_P1*(sd*sin(phi - theta) - thetad*cos(phi - theta)*(l5 + s)))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (l2*mu_B1*sin(phi - theta)*(l5 + s)*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2)) - (l2*mu_P1*sin(phi - theta)*(l5 + s)*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(3/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) - (sin(conj(theta))*sin(theta)*(conj(l5) + conj(s))*(l5 + s)*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2) + (sin(conj(theta))*(conj(l5) + conj(s))*(2*abs(cos(theta)*(l5 + s) - l2*cos(phi))*sin(theta)*sign(cos(theta)*(l5 + s) - l2*cos(phi))*(l5 + s) - 2*sign(sin(theta)*(l5 + s) - l2*sin(phi))*cos(theta)*abs(sin(theta)*(l5 + s) - l2*sin(phi))*(l5 + s))*(cos(theta)*(l5 + s) - l2*cos(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(2*(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(3/2)) - (cos(conj(theta))*(conj(l5) + conj(s))*(2*abs(cos(theta)*(l5 + s) - l2*cos(phi))*sin(theta)*sign(cos(theta)*(l5 + s) - l2*cos(phi))*(l5 + s) - 2*sign(sin(theta)*(l5 + s) - l2*sin(phi))*cos(theta)*abs(sin(theta)*(l5 + s) - l2*sin(phi))*(l5 + s))*(sin(theta)*(l5 + s) - l2*sin(phi))*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(2*(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(3/2)) - (cos(conj(theta))*cos(theta)*(conj(l5) + conj(s))*(l5 + s)*((mu_B1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_B1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - tau_B1/r_B1 + (mu_P1*(sd*(l5 + s) - l2*(sd*cos(phi - theta) + thetad*sin(phi - theta)*(l5 + s))))/(r_P1*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2))))/(abs(cos(theta)*(l5 + s) - l2*cos(phi))^2 + abs(sin(theta)*(l5 + s) - l2*sin(phi))^2)^(1/2);



Q_theta_dx(3) = (sin(conj(theta))*conj(s)*cos(theta)*(mu_P2*r_B2 + mu_B2*r_P2))/(r_B2*r_P2) - (cos(conj(theta))*conj(s)*sin(theta)*(mu_P2*r_B2 + mu_B2*r_P2))/(r_B2*r_P2) + (sin(conj(theta))*(s*abs(l5)^2 + l5*abs(s)^2)*(mu_P1*r_B1 + mu_B1*r_P1)*(l5 + s - l2*cos(phi - theta))*(l5*cos(theta) - l2*cos(phi) + s*cos(theta)))/(l5*r_B1*r_P1*s*(abs(- l2*cos(phi) + l5*cos(theta) + s*cos(theta))^2 + abs(- l2*sin(phi) + l5*sin(theta) + s*sin(theta))^2)^(1/2)*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (cos(conj(theta))*(s*abs(l5)^2 + l5*abs(s)^2)*(mu_P1*r_B1 + mu_B1*r_P1)*(l5 + s - l2*cos(phi - theta))*(l5*sin(theta) - l2*sin(phi) + s*sin(theta)))/(l5*r_B1*r_P1*s*(abs(- l2*cos(phi) + l5*cos(theta) + s*cos(theta))^2 + abs(- l2*sin(phi) + l5*sin(theta) + s*sin(theta))^2)^(1/2)*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2));



Q_theta_dx(4) = (l2*sin(phi - theta)*cos(conj(theta))*(l5 + s)*(s*abs(l5)^2 + l5*abs(s)^2)*(mu_P1*r_B1 + mu_B1*r_P1)*(l5*sin(theta) - l2*sin(phi) + s*sin(theta)))/(l5*r_B1*r_P1*s*(abs(- l2*cos(phi) + l5*cos(theta) + s*cos(theta))^2 + abs(- l2*sin(phi) + l5*sin(theta) + s*sin(theta))^2)^(1/2)*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2)) - (l2*sin(phi - theta)*sin(conj(theta))*(l5 + s)*(s*abs(l5)^2 + l5*abs(s)^2)*(mu_P1*r_B1 + mu_B1*r_P1)*(l5*cos(theta) - l2*cos(phi) + s*cos(theta)))/(l5*r_B1*r_P1*s*(abs(- l2*cos(phi) + l5*cos(theta) + s*cos(theta))^2 + abs(- l2*sin(phi) + l5*sin(theta) + s*sin(theta))^2)^(1/2)*((l5 + s)^2 + l2^2 - 2*l2*cos(phi - theta)*(l5 + s))^(1/2));
